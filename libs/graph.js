// Raw Data here
const raw_data = {
  nodes: [
    {
      name: "INSTRUCTIONS [CLICK ME]",
      group: "4",
      image: "None",
      type: "Comment/Opinion",
      author: "None",
      date: "5/6/2022, 4:06:16 PM",
      text: "<ul><li>-Click on each circles to read more.</li><li>-Scroll Mouse to Zoom.</li><li>-Drag around with mouse to explore. </li><li>-Click Back to top on the bottom-left to go back to the Response 4 essay.</li><li>-<b><u>Click on black area</u></b> to de-select.</li><ul>",
      x: 796.9548536911508,
      y: 370.92597250747644,
      index: 0,
      weight: 1,
      px: 796.8824323790973,
      py: 370.99731451608,
      fixed: 0,
    },
    {
      name: "Data Brokerage",
      group: "2",
      image: "./images/mindmap/1.jpeg",
      type: "Theme",
      author: "None",
      date: "5/12/2022, 9:10:10 AM",
      text: "The process of collecting personal data and selling to third parties. This is closely linked to the topic of privacy.",
      x: 1028.7439346904146,
      y: 291.1070661075511,
      index: 1,
      weight: 1,
      px: 1028.4564766860083,
      py: 291.2637321491791,
      fixed: 0,
    },
    {
      name: "Big Other",
      group: "2",
      image: "./images/mindmap/3.jpeg",
      type: "Theme",
      author: "Shoshana Zuboff",
      date: "5/12/2022, 9:10:46 AM",
      text: "It is a ubiquitous networked institutional regime that records, modifies, and commodifies everyday experience from toasters to bodies, communication to thought, all with a view to establishing new pathways to monetization and profit",
      x: 914.0692509765325,
      y: 236.08116273838456,
      index: 2,
      weight: 1,
      px: 914.0006537752628,
      py: 236.379697011727,
      fixed: 0,
    },
    {
      name: "Smart Toothbrush",
      group: "2",
      image: "./images/mindmap/2.webp",
      type: "Theme",
      author: "None",
      date: "5/12/2022, 9:11:09 AM",
      text: "A toothbrush connected to your phone to record and analyze your dental data. It came up during our last class conversation, and I think it's a product of capitalism.",
      x: 930.814919165915,
      y: 743.2336588008565,
      index: 3,
      weight: 1,
      px: 930.5241328801382,
      py: 742.859177685302,
      fixed: 0,
    },
    {
      name: "Surveillance Capitalism",
      group: "2",
      image: "./images/res_2_surveil.jpeg",
      type: "Theme",
      author: "Shoshana Zuboff",
      date: "5/12/2022, 9:11:33 AM",
      text: "Surveillance Capitalism means that Big Tech corporations have been finding stealthy ways to collect our data and turn it into a market commodity. I think it concerns with our privacy.",
      x: 1122.5759983154826,
      y: 296.65093167342656,
      index: 4,
      weight: 2,
      px: 1122.011913477305,
      py: 296.8366850331281,
      fixed: 0,
    },
    {
      name: "Panopticon",
      group: "2",
      image: "./images/mindmap/4.jpeg",
      type: "Theme",
      author: "Jeremy Bentham ",
      date: "5/12/2022, 9:11:49 AM",
      text: "Panopticon is a building designed to allow all prisoners of an institution to be observed by a single security guard, without the inmates being able to tell whether they are being watched. Foucault compares schools and workplace as Panopticons-like places, so that they are connected.",
      x: 1042.6621544119091,
      y: 225.7780186098945,
      index: 5,
      weight: 2,
      px: 1042.2727548346545,
      py: 226.1906787887392,
      fixed: 0,
    },
    {
      name: "Benjamin Franklin",
      group: "2",
      image: "./images/mindmap/5.jpeg",
      type: "Theme",
      author: "None",
      date: "5/12/2022, 9:12:06 AM",
      text: "Benjamin Franklin was one of the earliest recorded people who quantified themselves to improve their virtues.",
      x: 496.0101216424026,
      y: 218.36679316081734,
      index: 6,
      weight: 1,
      px: 496.26540268018465,
      py: 218.61470415869968,
      fixed: 0,
    },
    {
      name: "Right to Repair",
      group: "2",
      image: "./images/mindmap/6.jpeg",
      type: "Theme",
      author: "None",
      date: "5/12/2022, 9:12:33 AM",
      text: "Right to Repair is a proposed legislation that would provide the practical means for electronics equipment owners to repair their devices. It is a response to planned obsolescence.",
      x: 881.6232782540624,
      y: 947.8412962874486,
      index: 7,
      weight: 1,
      px: 881.505255751628,
      py: 947.3845231307787,
      fixed: 0,
    },
    {
      name: "Planned Obsolescence",
      group: "2",
      image: "./images/mindmap/7.jpeg",
      type: "Theme",
      author: "None",
      date: "5/12/2022, 9:13:16 AM",
      text: "Planned obsolescence is a purposeful strategy to ensure the current version of a product will become out of date or useless within a known time period.",
      x: 851.8879904126711,
      y: 807.0789153894204,
      index: 8,
      weight: 2,
      px: 851.7918441792453,
      py: 806.6324183297023,
      fixed: 0,
    },
    {
      name: "Right to be forgotten",
      group: "2",
      image: "./images/mindmap/8.png",
      type: "Theme",
      author: "None",
      date: "5/12/2022, 9:13:38 AM",
      text: "The right to have private information about a person be removed from Internet searches and other directories under some circumstances. ",
      x: 1263.8595402852195,
      y: 226.13974686208644,
      index: 9,
      weight: 1,
      px: 1263.3904441145464,
      py: 226.32629288056225,
      fixed: 0,
    },
    {
      name: "Dead Bots",
      group: "2",
      image: "./images/mindmap/9.jpeg",
      type: "Theme",
      author: "None",
      date: "5/12/2022, 9:13:50 AM",
      text: "In class discussions, we also talked about what happens to our data online after we die, and the possibility of reviving a person with a virtual avatar from their data.",
      x: 676.4225603630271,
      y: 213.2222342131741,
      index: 10,
      weight: 2,
      px: 676.360678154655,
      py: 213.53249306045745,
      fixed: false,
    },
    {
      name: "Deep Listening",
      group: "2",
      image: "./images/mindmap/10.webp",
      type: "Theme",
      author: "None",
      date: "5/12/2022, 9:13:59 AM",
      text: "Deep Listening is a concept by Sam Green mentioned during the screening of his documentary, 32 Sounds.",
      x: 586.9723248963485,
      y: 192.31923436620386,
      index: 11,
      weight: 1,
      px: 587.0377289556884,
      py: 192.6033880597928,
      fixed: 0,
    },
    {
      name: "Capitalism",
      group: "3",
      image: "./images/mindmap/11.jpeg",
      type: "Media",
      author: "None",
      date: "5/12/2022, 9:15:09 AM",
      text: "Anything which is about Capitalism",
      x: 825.6281821052146,
      y: 632.0754717344468,
      index: 12,
      weight: 6,
      px: 825.5271272293265,
      py: 631.7043083982788,
      fixed: false,
    },
    {
      name: "Privacy",
      group: "3",
      image: "./images/mindmap/12.jpeg",
      type: "Media",
      author: "None",
      date: "5/12/2022, 9:15:30 AM",
      text: "Anything which is about Privacy",
      x: 931.4767860734568,
      y: 374.08526640057676,
      index: 13,
      weight: 13,
      px: 931.2974661421321,
      py: 374.12797593445225,
      fixed: 0,
    },
    {
      name: "Data",
      group: "3",
      image: "./images/mindmap/13.jpeg",
      type: "Media",
      author: "None",
      date: "5/12/2022, 9:16:37 AM",
      text: "Anything which is about Data",
      x: 585.6037683282887,
      y: 323.7319686581961,
      index: 14,
      weight: 11,
      px: 585.7123170837397,
      py: 323.7767826498213,
      fixed: 0,
    },
    {
      name: "Quantified Self",
      group: "3",
      image: "./images/mindmap/14.jpeg",
      type: "Media",
      author: "None",
      date: "5/12/2022, 9:19:37 AM",
      text: "Quantified Self, the core topic of this class.",
      x: 746.42339988584,
      y: 466.456287899945,
      index: 15,
      weight: 5,
      px: 746.4418405882085,
      py: 466.39520482675323,
      fixed: 0,
    },
    {
      name: "Data feminism",
      group: "2",
      image: "./images/mindmap/15.webp",
      type: "Theme",
      author: "D'Ignazio and Klein",
      date: "5/12/2022, 9:39:22 AM",
      text: "Data feminism is a concept by  D'Ignazio and Klein about how the differentials of power can be challenged and changed in data science. In class, we talked about the need to understand the labour that goes into making that data.",
      x: 444.90172104463625,
      y: 306.0397371206205,
      index: 16,
      weight: 1,
      px: 445.28296545034436,
      py: 306.10311913835415,
      fixed: 0,
    },
    {
      name: "Dear Data",
      group: "2",
      image: "./images/mindmap/16.png",
      type: "Theme",
      author: "Giorgia Lupi and Stefanie Posavec",
      date: "5/20/2022, 7:23:56 PM",
      text: "Dear Data is a year-long, analog data drawing project by Giorgia Lupi and Stefanie Posavec, two award-winning information designers living on different sides of the Atlantic.",
      x: 311.45040615076095,
      y: 548.957102219442,
      index: 17,
      weight: 1,
      px: 311.8753882879954,
      py: 548.7145748608875,
      fixed: 0,
    },
    {
      name: "Visualizations",
      group: "3",
      image: "./images/mindmap/18.png",
      type: "Media",
      author: "None",
      date: "5/20/2022, 7:24:46 PM",
      text: "All things related to data visualizations",
      x: 437.56553091636107,
      y: 455.3851410356575,
      index: 18,
      weight: 4,
      px: 437.91742497713653,
      py: 455.2245117787214,
      fixed: 0,
    },
    {
      name: "W.E.B Dubois",
      group: "2",
      image: "None",
      type: "Theme",
      author: "None",
      date: "5/20/2022, 7:25:37 PM",
      text: "",
      x: 278.14848555487504,
      y: 459.97181757569075,
      index: 19,
      weight: 1,
      px: 278.65089586179454,
      py: 459.92639501609966,
      fixed: false,
    },
    {
      name: "Pi's Mindmap",
      group: "2",
      image: "./images/mindmap/17.png",
      type: "Theme",
      author: "Pi Ko",
      date: "5/20/2022, 7:26:27 PM",
      text: "This mindmap is a work of art in itself",
      x: 447.52319883009176,
      y: -2.48266882126973,
      index: 20,
      weight: 1,
      px: 447.83019005929054,
      py: -2.097441788324159,
      fixed: 0,
    },
    {
      name: "Art",
      group: "3",
      image: "None",
      type: "Media",
      author: "None",
      date: "5/20/2022, 7:26:41 PM",
      text: "",
      x: 549.7099550384668,
      y: 112.06771774646536,
      index: 21,
      weight: 4,
      px: 549.8483693692314,
      py: 112.47481627103453,
      fixed: 0,
    },
    {
      name: "Tools",
      group: "3",
      image: "None",
      type: "Media",
      author: "None",
      date: "5/20/2022, 8:03:59 PM",
      text: "",
      x: 648.2462001716547,
      y: 628.5466558849291,
      index: 22,
      weight: 6,
      px: 648.3632457352304,
      py: 628.2608877978723,
      fixed: 0,
    },
    {
      name: "Privacy Badger ",
      group: "2",
      image: "None",
      type: "Theme",
      author: "None",
      date: "5/20/2022, 8:04:19 PM",
      text: "",
      x: 809.2636066066702,
      y: 523.8782795539199,
      index: 23,
      weight: 2,
      px: 809.185868623835,
      py: 523.6663152087574,
      fixed: 0,
    },
    {
      name: "https://rawgraphs.io",
      group: "2",
      image: "None",
      type: "Theme",
      author: "None",
      date: "5/20/2022, 8:05:02 PM",
      text: "",
      x: 490.6431171569551,
      y: 595.8978309631207,
      index: 24,
      weight: 2,
      px: 490.95190634687475,
      py: 595.6580260007282,
      fixed: 0,
    },
    {
      name: "Discipline and Punish",
      group: "2",
      image: "None",
      type: "Theme",
      author: "Michel Foucault",
      date: "5/20/2022, 8:06:14 PM",
      text: "",
      x: 965.4767655578503,
      y: 193.36083023875665,
      index: 25,
      weight: 2,
      px: 965.2651533830971,
      py: 193.84949627889188,
      fixed: 0,
    },
    {
      name: "Sousveillance ",
      group: "2",
      image: "None",
      type: "Theme",
      author: "None",
      date: "5/20/2022, 8:07:02 PM",
      text: "",
      x: 1100.5757742431701,
      y: 430.13542353161245,
      index: 26,
      weight: 1,
      px: 1099.9979220123944,
      py: 429.9821295217797,
      fixed: false,
    },
    {
      name: "All Watched Over by Algorithms",
      group: "2",
      image: "None",
      type: "Theme",
      author: "Evgeny Morozov",
      date: "5/20/2022, 8:08:02 PM",
      text: "",
      x: 910.6095159631357,
      y: 518.8033572570413,
      index: 27,
      weight: 2,
      px: 910.4320625420445,
      py: 518.6516033218296,
      fixed: false,
    },
    {
      name: "Seeing 21st Century Data Bleed through the 15th Century Wound Man",
      group: "2",
      image: "None",
      type: "Theme",
      author: "Nikki Stevens",
      date: "5/20/2022, 8:10:02 PM",
      text: "",
      x: 1072.759701063568,
      y: 366.734289252216,
      index: 28,
      weight: 1,
      px: 1072.342970298502,
      py: 366.75426652224536,
      fixed: 0,
    },
    {
      name: "Databases",
      group: "3",
      image: "None",
      type: "Media",
      author: "None",
      date: "5/20/2022, 8:10:46 PM",
      text: "",
      x: 403.8378907870082,
      y: 236.5682820204062,
      index: 29,
      weight: 2,
      px: 404.305717113347,
      py: 236.80444794687838,
      fixed: false,
    },
    {
      name: "British Library Sound Archive ",
      group: "2",
      image: "None",
      type: "Theme",
      author: "None",
      date: "5/20/2022, 8:11:01 PM",
      text: "",
      x: 253.19337377634866,
      y: 177.46605434554448,
      index: 30,
      weight: 1,
      px: 253.64922373785072,
      py: 177.6628327339283,
      fixed: 0,
    },
    {
      name: "32 Sounds",
      group: "2",
      image: "./images/mindmap/10.webp",
      type: "Theme",
      author: "Sam Green",
      date: "5/20/2022, 8:11:38 PM",
      text: "A documentary film about sound by Sam Green",
      x: 527.0551310471656,
      y: -44.35098732858135,
      index: 31,
      weight: 1,
      px: 527.1916371889738,
      py: -43.86562099032168,
      fixed: 0,
    },
    {
      name: "Survey123",
      group: "2",
      image: "None",
      type: "Theme",
      author: "None",
      date: "5/20/2022, 8:12:23 PM",
      text: "",
      x: 659.0220025081128,
      y: 777.4634700030224,
      index: 32,
      weight: 1,
      px: 659.0364381263654,
      py: 777.0118379622493,
      fixed: 0,
    },
    {
      name: "On Tracking in the Workplace",
      group: "2",
      image: "None",
      type: "Theme",
      author: "Nancy Gleason",
      date: "5/20/2022, 8:14:08 PM",
      text: "",
      x: 957.9460595522553,
      y: 550.4305709381874,
      index: 33,
      weight: 2,
      px: 957.5643524976953,
      py: 550.0960087932999,
      fixed: false,
    },
    {
      name: "DATA NOT FOUND",
      group: "2",
      image: "None",
      type: "Theme",
      author: "Kaki King",
      date: "5/20/2022, 8:15:08 PM",
      text: "",
      x: 613.5736159834958,
      y: -32.65993516526569,
      index: 34,
      weight: 1,
      px: 613.517928271199,
      py: -32.20149592250335,
      fixed: 0,
    },
    {
      name: "A Day Made of Glass",
      group: "2",
      image: "None",
      type: "Theme",
      author: "Corning",
      date: "5/20/2022, 8:16:28 PM",
      text: "",
      x: 669.0424966873253,
      y: 493.4472777179435,
      index: 35,
      weight: 2,
      px: 669.2143206909067,
      py: 493.3068847022106,
      fixed: 0,
    },
    {
      name: "Voyant Tools",
      group: "2",
      image: "None",
      type: "Theme",
      author: "None",
      date: "5/20/2022, 8:27:20 PM",
      text: "An open-source, web-based application for performing text analysis. I used it extensively for text analysis throughout responses and assignments in this class.",
      x: 579.1116700344938,
      y: 773.7278337985431,
      index: 36,
      weight: 1,
      px: 579.3140805818864,
      py: 773.2590184574706,
      fixed: 0,
    },
    {
      name: "ExifTool",
      group: "2",
      image: "None",
      type: "Theme",
      author: "None",
      date: "5/20/2022, 8:28:16 PM",
      text: "A free and open-source software program for reading, writing, and manipulating image, audio, video, and PDF metadata.",
      x: 522.2342497894896,
      y: 720.9142224207354,
      index: 37,
      weight: 1,
      px: 522.5640309490557,
      py: 720.5769984009569,
      fixed: 0,
    },
    {
      name: "General Data Protection Regulation",
      group: "2",
      image: "None",
      type: "Theme",
      author: "None",
      date: "5/20/2022, 8:29:58 PM",
      text: "",
      x: 1047.2539114347042,
      y: 475.9694756932699,
      index: 38,
      weight: 1,
      px: 1046.869039600398,
      py: 475.7286597038593,
      fixed: false,
    },
    {
      name: "Google Takeout",
      group: "2",
      image: "None",
      type: "Theme",
      author: "None",
      date: "5/20/2022, 8:30:22 PM",
      text: "",
      x: 473.62012927997205,
      y: 375.99110666332064,
      index: 39,
      weight: 1,
      px: 473.87762252680034,
      py: 375.92794902989976,
      fixed: false,
    },
    {
      name: "Powerful Mexicans Pay to Scrub their Reputations Online",
      group: "2",
      image: "None",
      type: "Theme",
      author: "None",
      date: "5/20/2022, 8:32:47 PM",
      text: "",
      x: 761.3655215188182,
      y: 292.0956096019174,
      index: 40,
      weight: 3,
      px: 761.3234553977906,
      py: 292.3413435908241,
      fixed: 0,
    },
  ],
  links: [
    { source: 4, target: 9 },
    { source: 12, target: 7 },
    { source: 8, target: 12 },
    { source: 4, target: 13 },
    { source: 12, target: 3 },
    { source: 13, target: 2 },
    { source: 13, target: 1 },
    { source: 5, target: 13 },
    { source: 14, target: 6 },
    { source: 11, target: 14 },
    { source: 14, target: 10 },
    { source: 13, target: 15 },
    { source: 14, target: 15 },
    { source: 15, target: 12 },
    { source: 14, target: 16 },
    { source: 0, target: 15 },
    { source: 18, target: 14 },
    { source: 18, target: 17 },
    { source: 19, target: 18 },
    { source: 21, target: 14 },
    { source: 21, target: 20 },
    { source: 22, target: 15 },
    { source: 23, target: 22 },
    { source: 13, target: 23 },
    { source: 24, target: 18 },
    { source: 22, target: 24 },
    { source: 25, target: 13 },
    { source: 25, target: 5 },
    { source: 26, target: 13 },
    { source: 27, target: 13 },
    { source: 27, target: 12 },
    { source: 28, target: 13 },
    { source: 29, target: 14 },
    { source: 29, target: 30 },
    { source: 31, target: 21 },
    { source: 22, target: 32 },
    { source: 33, target: 12 },
    { source: 33, target: 13 },
    { source: 34, target: 21 },
    { source: 12, target: 35 },
    { source: 14, target: 35 },
    { source: 22, target: 37 },
    { source: 22, target: 36 },
    { source: 38, target: 13 },
    { source: 39, target: 14 },
    { source: 40, target: 13 },
    { source: 40, target: 14 },
    { source: 10, target: 40 },
  ],
};

// console.log(raw_data.nodes);

//AJAX Request
var request;
var editModeOn = false;
var width = window.innerWidth,
  height = window.innerHeight,
  // var width = 960,
  //   height = 500,
  selected_node,
  selected_target_node,
  selected_link,
  new_line,
  circlesg,
  linesg,
  should_drag = false,
  drawing_line = false,
  nodes = [],
  links = [],
  link_distance = 90;

var zoomEnabled;
var allNodes;
var allLinks;
var showText = true;
var currentNodeText;
//Color Coding
function color(n) {
  var color_list = ["#ffffff", "#ffffff", "#00A86B", "#ad0303", "#0077b6"];
  return color_list[n % color_list.length];
}

var default_name = "Node";

var force = d3.layout
  .force()
  .charge(-1500)
  .linkDistance(link_distance)
  .size([width, height]);

// var zoom = d3.behavior.zoom().on("zoom", function () {
//   svg.attr(
//     "transform",
//     "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")"
//   );
// });

var zoom = d3.behavior.zoom().on("zoom", function () {
  svg.attr(
    "transform",
    "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")"
  );
});

var svgRaw = d3
  .select("#chart")
  .append("svg")
  .attr("width", width)
  .attr("height", height);
//Activate the zoom
svgRaw.call(zoom);

var svg = svgRaw.append("g");

d3.select(window)
  .on("mousemove", mousemove)
  .on("mouseup", mouseup)
  .on("keydown", keydown)
  .on("keyup", keyup);

svg
  .append("rect")
  .attr("width", width)
  .attr("height", height)
  .on("mousedown", mousedown);

// Arrow marker
svg
  .append("svg:defs")
  .selectAll("marker")
  .data(["child"])
  .enter()
  .append("svg:marker")
  .attr("id", String)
  .attr("markerUnits", "userSpaceOnUse")
  .attr("viewBox", "0 -5 10 10")
  .attr("refX", link_distance / 2)
  .attr("markerWidth", 10)
  .attr("markerHeight", 10)
  .attr("orient", "auto")
  .append("svg:path")
  .attr("d", "M0,-5L10,0L0,5");

linesg = svg.append("g");
circlesg = svg.append("g");

//Dynamic file loading
if (localStorage.getItem("lastSavedData") === null) {
  nodes = raw_data.nodes;
  links = raw_data.links;
  update();
  force = force.nodes(nodes).links(links);
  force.start();
} else {
  const json = raw_data;
  // decorate a node with a count of its children
  nodes = json.nodes;
  links = json.links;
  update();
  force = force.nodes(nodes).links(links);
  force.start();
}

function update() {
  var link = linesg
    .selectAll("line.link")
    .data(links)
    .attr("x1", function (d) {
      return d.source.x;
    })
    .attr("y1", function (d) {
      return d.source.y;
    })
    .attr("x2", function (d) {
      return d.target.x;
    })
    .attr("y2", function (d) {
      return d.target.y;
    })
    .classed("selected", function (d) {
      return d === selected_link;
    });
  link
    .enter()
    .append("line")
    .attr("class", "link")
    .attr("marker-end", "url(#child)")
    .on("mousedown", line_mousedown);
  link.exit().remove();

  allLinks = link;

  var node = circlesg
    .selectAll(".node")
    .data(nodes, function (d) {
      return d.name;
    })
    .classed("selected", function (d) {
      return d === selected_node;
    })
    .classed("selected_target", function (d) {
      return d === selected_target_node;
    });
  var nodeg = node
    .enter()
    .append("g") //Only show the text after over
    .on("mouseover", appendText)
    .on("mouseout", function () {
      // Remove the info text on mouse out.
      d3.select(this).select("text.info").remove();
    })
    .attr("class", "node")
    .call(force.drag)
    .attr("transform", function (d) {
      if (d.x == undefined) {
        d.x = 0;
      }
      if (d.y == undefined) {
        d.y = 0;
      }
      return "translate(" + d.x + "," + d.y + ")";
    });
  nodeg
    .append("circle")
    .attr("r", 10)
    .on("mousedown", node_mousedown)
    .on("mouseover", node_mouseover)
    .on("mouseout", node_mouseout)
    .style("fill", function (d) {
      return color(d.group); //Color the nodes differently according to category
    })
    .style("opacity", 0.8);

  allNodes = nodeg;
  //Append or not append text, we can choose
  nodeg
    .append("text")
    .classed("nodeText", true)
    .attr("x", 20)
    .attr("y", 10)
    .text(function (d) {
      return d.name;
    });

  node.exit().remove();

  force.on("tick", function (e) {
    link
      .attr("x1", function (d) {
        return d.source.x;
      })
      .attr("y1", function (d) {
        return d.source.y;
      })
      .attr("x2", function (d) {
        return d.target.x;
      })
      .attr("y2", function (d) {
        return d.target.y;
      });
    node.attr("transform", function (d) {
      if (d.x == undefined) {
        d.x = 0;
      }
      if (d.y == undefined) {
        d.y = 0;
      }
      return "translate(" + d.x + "," + d.y + ")";
    });
  });
}

function appendText(d) {
  var g = d3.select(this); // The node
  // The class is used to remove the additional text later
  // This highlights the text
  var info = g
    .append("text")
    .classed("info", true)
    .attr("x", 20)
    .attr("y", 10)
    .text(function (d) {
      return d.name;
    });
}

// select target node for new node connection
function node_mouseover(d) {
  if (drawing_line && d !== selected_node) {
    // highlight and select target node
    selected_target_node = d;
  }
}

function node_mouseout(d) {
  if (drawing_line) {
    selected_target_node = null;
  }
}

function zoomToNode(d) {
  if (should_drag == false) {
    var translate = [
      width / 2 - zoom.scale() * d.x,
      height / 2 - zoom.scale() * d.y,
    ];
    svg
      .transition()
      .duration(750)
      .call(zoom.translate(translate).scale(zoom.scale()).event);
  }
}

// select node / start drag
function node_mousedown(d) {
  showText = !showText;
  //Clear other texts and append
  var g = d3.select(this); // The node
  // The class is used to remove the additional text later
  var info = g
    .append("text")
    .classed("info", true)
    .attr("x", 20)
    .attr("y", 10)
    .text(d.name);

  //Zoom to that node, when clicked
  zoomToNode(d);
  if (!drawing_line) {
    selected_node = d;
    showInfo(d);
    selected_link = null;
  }
  if (!should_drag) {
    d3.event.stopPropagation();
    drawing_line = true;
  }
  //Pinning the node. Change to true if you want to pin.
  d.fixed = false;
  force.stop();
  //Process the highlight
  //Reduce the opacity of all but the neighbouring nodes
  d = d3.select(this).node().__data__;
  currentNodeText = d;
  allNodes.style("opacity", function (o) {
    return neighboring(d, o) | neighboring(o, d) ? 1 : 0.1;
  });

  allLinks.style("opacity", function (o) {
    return (d.index == o.source.index) | (d.index == o.target.index) ? 1 : 0.1;
  });
  update();
}

// select line
function line_mousedown(d) {
  selected_link = d;
  selected_node = null;
  update();
}

// draw yellow "new connector" line
function mousemove() {
  if (drawing_line && !should_drag) {
    var m = d3.mouse(svg.node());
    var x = Math.max(0, Math.min(width, m[0]));
    var y = Math.max(0, Math.min(height, m[1]));
    // debounce - only start drawing line if it gets a bit big
    var dx = selected_node.x - x;
    var dy = selected_node.y - y;
    if (Math.sqrt(dx * dx + dy * dy) > 10) {
      // draw a line
      if (!new_line) {
        // new_line = linesg.append("line").attr("class", "new_line");
      }
      // new_line
      //   .attr("x1", function (d) {
      //     return selected_node.x;
      //   })
      //   .attr("y1", function (d) {
      //     return selected_node.y;
      //   })
      //   .attr("x2", function (d) {
      //     return x;
      //   })
      //   .attr("y2", function (d) {
      //     return y;
      //   });
    }
  }
  update();
}

// add a new disconnected node, upon button click
var addNode = function (Title, fileName, Name, Type, TypeName, Content) {
  var date = new Date();
  var currentNode = {
    name: Title,
    group: Type,
    image: fileName,
    type: TypeName,
    author: Name,
    date: date.toLocaleString(),
    text: Content,
    x: width / 2,
    y: height / 2,
  };
  nodes.push(currentNode);
  selected_node = currentNode;
  selected_link = null;
  force.stop();
  update();
  force.start();
  saveJSON();
  showToast("Saved", 2);
};

// switch between drag mode and add mode
function mousedown() {
  if (selected_node != null) {
    //Reset the line display
    allNodes.style("opacity", 1);
    allLinks.style("opacity", 0.9);
    toggle = 0;
  }
  //Also clear all the texts
  d3.selectAll("text.info").remove();
  //Reset the nodes
  selected_node = null;
  selected_link = null;
  if (selected_node == null) {
    $("#imageCard").fadeOut();
  }
  update();
  force.start();
}

// end node select / add new connected node
function mouseup() {
  drawing_line = false;
  if (new_line) {
    if (selected_target_node) {
      selected_target_node.fixed = false;
      var new_node = selected_target_node;
    } else {
      var m = d3.mouse(svg.node());
      var new_node = {
        x: m[0],
        y: m[1],
        name: default_name + " " + nodes.length,
        group: 1,
      };
      nodes.push(new_node);
    }
    selected_node.fixed = false;
    links.push({ source: selected_node, target: new_node });
    //Update the links
    saveJSON();
    selected_node = selected_target_node = null;
    update();
    setTimeout(function () {
      new_line.remove();
      new_line = null;
      force.start();
    }, 300);
  }
}

function keyup() {
  switch (d3.event.keyCode) {
    case 16: {
      // shift
      should_drag = false;
      svgRaw.call(zoom);
      update();
      force.start();
    }
  }
}

// select for dragging node with shift; delete node with backspace
function keydown() {
  switch (d3.event.keyCode) {
    case 8: // backspace
    // case 46: {
    //   //Delete only when not editing
    //   if (editModeOn == false) {
    //     if (selected_node) {
    //       // deal with nodes
    //       var i = nodes.indexOf(selected_node);
    //       nodes.splice(i, 1);
    //       // find links to/from this node, and delete them too
    //       var new_links = [];
    //       links.forEach(function (l) {
    //         if (l.source !== selected_node && l.target !== selected_node) {
    //           new_links.push(l);
    //         }
    //       });
    //       links = new_links;
    //       selected_node = nodes.length ? nodes[i > 0 ? i - 1 : 0] : null;
    //     } else if (selected_link) {
    //       // deal with links
    //       var i = links.indexOf(selected_link);
    //       links.splice(i, 1);
    //       selected_link = links.length ? links[i > 0 ? i - 1 : 0] : null;
    //     }
    //     //Save JSON after deletion
    //     saveJSON();
    //     $("#imageCard").fadeOut();
    //     update();
    //   }
    //   break;
    // }
    case 16: {
      // shift
      should_drag = true;
      svgRaw.on(".zoom", null);
      break;
    }
  }
}

function get_file_name() {
  //Construct Filename
  const month = [
    "January",
    "February",
    "March",
    "April",
    "May",
    "June",
    "July",
    "August",
    "September",
    "October",
    "November",
    "December",
  ];
  var m = new Date();
  var dateString =
    m.getUTCFullYear() +
    "_" +
    month[m.getUTCMonth()] +
    "_" +
    ("0" + m.getUTCDate()).slice(-2) +
    "_" +
    ("0" + m.getUTCHours()).slice(-2) +
    "_" +
    ("0" + m.getUTCMinutes()).slice(-2) +
    "_" +
    ("0" + m.getUTCSeconds()).slice(-2);
  console.log(dateString);
  return dateString;
}

//GUI
//Show Information
function showInfo(d) {
  $("#titleText").html(d.name);
  $("#contentText").html(d.text);
  $("#contentAuthor").html(d.author);
  //$("#contentDate").html(d.date);
  //If there is no author, don't show the author info
  if (d.author == "None") {
    $("#authorInfo").hide();
  } else {
    $("#authorInfo").show();
  }
  //If there is no image, don't show
  if (d.image == "None" || d.image == undefined) {
    $("#cardImageContainer").hide();
    $("#cardImageSource").attr("src", "./img/white_image.png");
  } else {
    $("#cardImageSource").attr("src", d.image);
    $("#cardImageContainer").fadeIn();
  }
  $("#imageCard").fadeIn();
}

$(document).ready(function () {
  $("#imageCard").hide();
  //Disable Links
  if (allLinks != undefined) {
    allLinks.style("opacity", 0.9);
  }
});

$(document).on("click", "a", function () {
  var href = $(this).attr("href");
  if (href == "#closeForm") {
    $("#contentForm").fadeOut();
    editModeOn = false;
    clearText();
  } else if (href == "#openText") {
    //For Text
    $("#imgPreview").hide();
    $("#imageUploadForm").hide();
    localStorage.setItem("fileName", "None");
    $("#contentForm").fadeIn();
    $("#first_name").focus();
    editModeOn = true;
  } else if (href == "#openImage") {
    //For Image
    $("#imgPreview").hide();
    $("#imageURL").val("");
    $("#imageUploadForm").show();
    $("#contentForm").fadeIn();
    $("#first_name").focus();
    editModeOn = true;
  } else if (href == "#Submit") {
    Submit();
  } else if (href == "#OpenDialogue") {
  } else if (href == "#SaveFile") {
    downloadData();
  }
});

//Graph Traversal
//Toggle stores whether the highlighting is on
var toggle = 0;
//Create an array logging what is connected to what
var linkedByIndex = {};
for (i = 0; i < nodes.length; i++) {
  linkedByIndex[i + "," + i] = 1;
}
links.forEach(function (d) {
  linkedByIndex[d.source.index + "," + d.target.index] = 1;
});
//This function looks up whether a pair are neighbours
function neighboring(a, b) {
  return linkedByIndex[a.index + "," + b.index];
}

//Saving Functions
function saveJSON() {
  //console.log(nodes);
  //Node Parser
  var sourceid, targetid;
  var parsedlink = [];
  for (var j = 0; j < links.length; j++) {
    //console.log(links[j].source.name);
    for (var i = 0; i < nodes.length; i++) {
      //console.log(nodes[i].name);
      if (nodes[i].name == links[j].source.name) {
        sourceid = i;
      }
    }
    for (var i = 0; i < nodes.length; i++) {
      //console.log(nodes[i].name);
      if (nodes[i].name == links[j].target.name) {
        targetid = i;
      }
    }
    parsedlink.push({ source: sourceid, target: targetid });
  }
  //console.log(links);
  //console.log(parsedlink);
  var file_contents = JSON.stringify({
    nodes: nodes,
    links: parsedlink,
  });
  var currentTime = new Date().toLocaleString();
  //Very Important, save in chrome cache
  localStorage.setItem("lastSavedTime", currentTime);
  localStorage.setItem("lastSavedData", file_contents);
  console.log("File successfully saved locally at " + currentTime + ".");
}

function downloadData() {
  var sourceid, targetid;
  var parsedlink = [];
  for (var j = 0; j < links.length; j++) {
    //console.log(links[j].source.name);
    for (var i = 0; i < nodes.length; i++) {
      //console.log(nodes[i].name);
      if (nodes[i].name == links[j].source.name) {
        sourceid = i;
      }
    }
    for (var i = 0; i < nodes.length; i++) {
      //console.log(nodes[i].name);
      if (nodes[i].name == links[j].target.name) {
        targetid = i;
      }
    }
    parsedlink.push({ source: sourceid, target: targetid });
  }
  var blob = new Blob(
    [window.JSON.stringify({ nodes: nodes, links: parsedlink })],
    { type: "text/plain;charset=utf-8" }
  );
  saveAs(blob, get_file_name() + ".json");
}

function clearText() {
  $("#title").val("");
  $("#textarea1").val("");
  $("#first_name").val("");
}

function Submit() {
  var fileName = localStorage.getItem("fileName");
  if (fileName == null) {
    localStorage.setItem("fileName", "None");
  }
  var Name = $("#first_name").val();
  var Content = $("#textarea1").val();
  var Title = $("#title").val();
  if (Name == "") {
    Name = "None";
  }
  var Type = localStorage.getItem("type");
  var TypeName = localStorage.getItem("typeName");
  console.log("New Node Information - ");
  console.log("Image URL:" + fileName);
  console.log("Node Name:" + Name);
  console.log("Node Type:" + Type);
  console.log("Type Name:" + TypeName);
  //Add Node Finally
  if (Title == "") {
    showToast("No Title Given. Please put a title.", 4);
    $("#title").focus();
  } else {
    addNode(Title, fileName, Name, Type, TypeName, Content);
    //Hide content form
    $("#contentForm").fadeOut();
    editModeOn = false;
    clearText();
    //Clear Previous values
  }
}

/*Toast Function */
function showToast(message, seconds) {
  // Get the snackbar DIV
  var x = document.getElementById("snackbar");
  document.getElementById("snackbar").innerHTML = message;

  // Add the "show" class to DIV
  x.className = "show";
  // After 3 seconds, remove the show class from DIV
  setTimeout(function () {
    x.className = x.className.replace("show", "");
  }, seconds * 1000);
}
